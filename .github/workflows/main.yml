name: Build and Upload iOS to App Store

on:
  push:
    branches:
      - main

jobs:
  build_ios:
    name: Build iOS and Upload to TestFlight
    runs-on: macos-latest
    steps:
      # ‚úÖ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      # ‚úÖ –ö—ç—à–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É Unity
      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-iOS
          restore-keys: Library-

      # ‚úÖ –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é Unity
      - name: Activate Unity License
        run: |
          echo "üîë Activating Unity license..."
          UNITY_LICENSE_PATH=$HOME/.local/share/unity3d/Unity/Unity_lic.ulf
          echo "${{ secrets.UNITY_LICENSE }}" > "$UNITY_LICENSE_PATH"
          echo "‚úÖ Unity license activated."

      # ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ–º –±–∏–ª–¥ Unity –¥–ª—è iOS
      - name: Build iOS
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: iOS

      # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ IPA-—Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω
      - name: Check IPA file
        run: |
          if [ -f "build/iOS/*.ipa" ]; then
            echo "‚úÖ IPA file found."
          else
            echo "‚ùå ERROR: IPA file not found!"
            exit 1
          fi

      # ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º IPA –≤ App Store Connect
      - name: Upload iOS build to App Store
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: build/iOS/*.ipa
          app-store-connect-private-key: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          app-store-connect-key-id: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          app-store-connect-issuer-id: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          app-store-connect-app-id: "6742623321"

      # ‚úÖ –û—á–∏—â–∞–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é –ø–æ—Å–ª–µ –±–∏–ª–¥–∞
      - name: Cleanup Unity License
        if: always()
        run: |
          echo "üóëÔ∏è Removing Unity license..."
          rm -f ~/.local/share/unity3d/Unity/Unity_lic.ulf
          echo "‚úÖ Unity license removed."
